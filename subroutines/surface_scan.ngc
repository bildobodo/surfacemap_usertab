o<surface_scan> sub
  (MSG, Starting Surface Scan)
  
  ; ============================================================
  ; Read parameters from userspace variables
  ; ============================================================
  #<x0> = #3050           (Lower X coordinate of grid)
  #<x1> = #3051           (Upper X coordinate of grid)
  #<y0> = #3052           (Lower Y coordinate of grid)
  #<y1> = #3053           (Upper Y coordinate of grid)
  #<xprobes> = #3054      (Number of probe points in X direction)
  #<yprobes> = #3055      (Number of probe points in Y direction)
  #<fast_fr> = #3056      (Fast probe feedrate)
  #<slow_fr> = #3057      (Slow probe feedrate)
  #<safez> = #3058        (Safe/traverse Z height in current WCS)
  #<depthz> = #3059       (Maximum search depth - negative value)
  
  ; ============================================================
  ; Get into predictable state
  ; ============================================================
  M64 P0                  (Disable compensation)
  G90                     (Absolute positioning)
  G94                     (Feed per minute mode)
  G40                     (Cancel cutter compensation)
  G49                     (Cancel tool length offset)
  G80                     (Cancel canned cycles)
  
  ; ============================================================
  ; Calculate probe point spacing
  ; ============================================================
  ; Calculate distance between probe points
  ; For N points, we have N-1 intervals
  #<x_range> = [#<x1> - #<x0>]
  #<y_range> = [#<y1> - #<y0>]
  
  o100 if [#<xprobes> GT 1]
    #<x_spacing> = [#<x_range> / [#<xprobes> - 1]]
  o100 else
    #<x_spacing> = 0
  o100 endif
  
  o101 if [#<yprobes> GT 1]
    #<y_spacing> = [#<y_range> / [#<yprobes> - 1]]
  o101 else
    #<y_spacing> = 0
  o101 endif
  
  (MSG, Grid: X[#<x0> to #<x1>] Y[#<y0> to #<y1>], Spacing: X#<x_spacing> Y#<y_spacing>)
  
  ; ============================================================
  ; Calculate work coordinate offsets for logging
  ; ============================================================
  #<wco_x> = [#<_abs_x> - #<_x>]
  #<wco_y> = [#<_abs_y> - #<_y>]
  #<wco_z> = [#<_abs_z> - #<_z>]
  
  ; ============================================================
  ; Open probe results file and write header
  ; ============================================================
  (LOGOPEN,probe-results.txt)
  (LOG,WCO #<wco_x> #<wco_y> #<wco_z>)
  
  ; ============================================================
  ; Move to safe position
  ; ============================================================
  G0 G53 Z0               (Move to machine Z0 for safety)
  G0 X#<x0> Y#<y0>        (Move to starting XY position in current WCS)
  G0 Z#<safez>            (Move to safe Z in current WCS)
  
  (MSG, Beginning probe grid scan)
  
  ; ============================================================
  ; Probe grid with snaking pattern
  ; ============================================================
  #<row> = 0
  #<direction> = 1        (1 = left to right, -1 = right to left)
  
  o200 while [#<row> LT #<yprobes>]
    ; Calculate current Y position
    #<current_y> = [#<y0> + [#<row> * #<y_spacing>]]
    
    ; Determine starting column based on direction
    o210 if [#<direction> EQ 1]
      #<col> = 0
      #<col_end> = #<xprobes>
    o210 else
      #<col> = [#<xprobes> - 1]
      #<col_end> = -1
    o210 endif
    
    ; Probe all points in this row
    o220 while [[#<direction> EQ 1 AND #<col> LT #<col_end>] OR [#<direction> EQ -1 AND #<col> GT #<col_end>]]
      ; Calculate current X position
      #<current_x> = [#<x0> + [#<col> * #<x_spacing>]]
      
      ; Move to XY position
      G0 X#<current_x> Y#<current_y>
      
      ; Probe downward with fast feedrate
      G38.2 Z#<depthz> F#<fast_fr>
      
      ; If slow feedrate is enabled, retract slightly and probe again slowly
      o230 if [#<slow_fr> GT 0]
        G0 Z[#5063 + 0.1]    (Retract 0.1 units)
        G38.2 Z#<depthz> F#<slow_fr>
      o230 endif
      
      ; Log the probed point (machine coordinates)
      (LOG,#5061 #5062 #5063)
      
      ; Retract to safe Z
      G0 Z#<safez>
      
      ; Move to next column
      #<col> = [#<col> + #<direction>]
    o220 endwhile
    
    ; Toggle direction for next row (snake pattern)
    #<direction> = [0 - #<direction>]
    
    ; Move to next row
    #<row> = [#<row> + 1]
  o200 endwhile
  
  ; ============================================================
  ; Clean up and finish
  ; ============================================================
  (LOGCLOSE)
  G0 G53 Z0               (Return to machine Z0)
  G0 X#<x0> Y#<y0>        (Return to start position)
  
  (MSG, Surface scan complete. Results saved to probe-results.txt)
  
o<surface_scan> endsub

M2
